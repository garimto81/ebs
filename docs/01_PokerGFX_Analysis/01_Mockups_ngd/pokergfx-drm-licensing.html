<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PokerGFX - DRM 및 라이선스 시스템</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0e1a;
            color: #e0e0e0;
            padding: 40px 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 960px;
            margin: 0 auto;
            background: #151b2e;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        h1 {
            font-size: 28px;
            color: #4fc3f7;
            margin-bottom: 10px;
            text-align: center;
        }
        .subtitle {
            font-size: 16px;
            color: #81c784;
            margin-bottom: 30px;
            text-align: center;
        }
        .section {
            margin-bottom: 40px;
        }
        h2 {
            font-size: 20px;
            color: #ff9800;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ff9800;
        }
        .flow-diagram {
            background: #1a2332;
            padding: 20px;
            border-radius: 6px;
            border-left: 4px solid #4fc3f7;
        }
        .flow-step {
            display: flex;
            flex-direction: column;
            margin-bottom: 12px;
        }
        .flow-box {
            background: #2a3547;
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 8px;
            border-left: 3px solid #81c784;
        }
        .flow-box.dongle {
            border-left-color: #ff9800;
        }
        .flow-box.server {
            border-left-color: #e91e63;
        }
        .flow-box.security {
            border-left-color: #9c27b0;
        }
        .flow-arrow {
            color: #4fc3f7;
            margin-left: 20px;
            font-size: 14px;
        }
        .code-ref {
            color: #ffab40;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            margin-left: 10px;
        }
        .license-tier {
            background: #1a2332;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        .tier-header {
            font-weight: bold;
            color: #81c784;
            margin-bottom: 8px;
            font-size: 16px;
        }
        .tier-value {
            color: #ffab40;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .tier-description {
            color: #b0bec5;
            margin-top: 8px;
            font-size: 14px;
        }
        .data-structure {
            background: #1a2332;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
        }
        .code-keyword {
            color: #81c784;
        }
        .code-type {
            color: #4fc3f7;
        }
        .code-property {
            color: #ffab40;
        }
        .code-comment {
            color: #757575;
        }
        .properties-list {
            background: #1a2332;
            padding: 15px;
            border-radius: 6px;
        }
        .property-item {
            margin-bottom: 12px;
            padding: 10px;
            background: #2a3547;
            border-radius: 4px;
        }
        .property-name {
            color: #ffab40;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        .property-desc {
            color: #b0bec5;
            margin-top: 4px;
            font-size: 14px;
        }
        .security-table {
            width: 100%;
            background: #1a2332;
            border-radius: 6px;
            overflow: hidden;
        }
        .security-table th,
        .security-table td {
            padding: 12px 15px;
            text-align: left;
        }
        .security-table th {
            background: #2a3547;
            color: #81c784;
            font-weight: bold;
        }
        .security-table tr:nth-child(even) {
            background: #1f2838;
        }
        .security-table td:first-child {
            color: #ff9800;
            font-weight: bold;
        }
        .security-table td:nth-child(2) {
            color: #4fc3f7;
        }
        .security-table td:nth-child(3) {
            color: #ffab40;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .hierarchy {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        .hierarchy-item {
            margin-left: 0;
            padding-left: 20px;
            border-left: 3px solid #81c784;
        }
        .hierarchy-item.pro {
            margin-left: 20px;
            border-left-color: #4fc3f7;
        }
        .hierarchy-item.basic {
            margin-left: 40px;
            border-left-color: #ffab40;
        }
        .state-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .state-item {
            background: #2a3547;
            padding: 10px;
            border-radius: 4px;
            border-left: 3px solid #81c784;
        }
        .state-name {
            color: #ffab40;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        .state-desc {
            color: #b0bec5;
            font-size: 13px;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>DRM 및 라이선스 시스템</h1>
        <div class="subtitle">KEYLOK USB Dongle + 원격 서버 검증 - 3계층 라이선스 모델</div>

        <!-- Section 1: 라이선스 검증 흐름 -->
        <div class="section">
            <h2>Section 1: 라이선스 검증 흐름</h2>
            <div class="flow-diagram">
                <div class="flow-step">
                    <div class="flow-box">
                        [Application Startup]
                    </div>
                    <div class="flow-arrow">↓</div>
                </div>

                <div class="flow-step">
                    <div class="flow-box dongle">
                        [DongleService.IsPresent()]
                        <span class="code-ref">DongleService.cs:145-209</span>
                    </div>
                    <div class="flow-arrow">↓ Challenge-Response protocol</div>
                    <div class="flow-arrow">↓ ValidateCode1, ValidateCode2, ValidateCode3</div>
                </div>

                <div class="flow-step">
                    <div class="flow-box dongle">
                        [KeylokDongle P/Invoke]
                        <span class="code-ref">KeylokDongle.cs:96-115</span>
                        <div style="margin-top: 8px; font-size: 12px; color: #b0bec5;">
                            ├── KFUNC(arg1, arg2, arg3, arg4) → uint<br>
                            ├── KBLOCK(task, address, byteCount, pArray) → uint<br>
                            ├── KGETGUSN(pArray) → Global Unique S/N<br>
                            ├── KGETSNS(pSNArray, iMaxSN) → uint<br>
                            └── GETLASTKEYERROR() → int
                        </div>
                        <div style="margin-top: 8px; font-size: 12px; color: #ff9800;">
                            DLL: KL2DLL64.DLL (64-bit native)
                        </div>
                    </div>
                    <div class="flow-arrow">↓</div>
                </div>

                <div class="flow-step">
                    <div class="flow-box dongle">
                        [Read SerialNumber + GlobalID]
                    </div>
                    <div class="flow-arrow">↓</div>
                </div>

                <div class="flow-step">
                    <div class="flow-box server">
                        [HTTP GET → license?id={SerialNumber}]
                        <span class="code-ref">LicenseService.cs:209-216</span>
                    </div>
                    <div class="flow-arrow">↓</div>
                </div>

                <div class="flow-step">
                    <div class="flow-box server">
                        [Remote License Server]
                    </div>
                    <div class="flow-arrow">↓ RemoteLicenseResponse (JSON + RSA Signature)</div>
                </div>

                <div class="flow-step">
                    <div class="flow-box security">
                        [Verify Signature]
                        <span class="code-ref">LicenseService.cs:274</span>
                        <div style="margin-top: 8px; font-size: 12px; color: #b0bec5;">
                            licenseService.VerifySignature(<br>
                            &nbsp;&nbsp;ReconstructBinaryData(serial, expiration, licenses),<br>
                            &nbsp;&nbsp;remoteLicenseResponse.Signature<br>
                            )
                        </div>
                    </div>
                    <div class="flow-arrow">↓</div>
                </div>

                <div class="flow-step">
                    <div class="flow-box">
                        [Write to Local File + Dongle Memory]
                    </div>
                    <div class="flow-arrow">↓</div>
                </div>

                <div class="flow-step">
                    <div class="flow-box" style="border-left-color: #81c784;">
                        [License Active]
                    </div>
                    <div class="flow-arrow">↓ Background periodic re-check</div>
                </div>

                <div class="flow-step">
                    <div class="flow-box">
                        [LicenseBackgroundService]
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 2: 3계층 라이선스 모델 -->
        <div class="section">
            <h2>Section 2: 3계층 라이선스 모델</h2>

            <div class="data-structure">
<span class="code-keyword">internal enum</span> <span class="code-type">LicenseType</span> : <span class="code-type">byte</span> {
    Basic = <span class="code-property">1</span>,
    Professional = <span class="code-property">4</span>,
    Enterprise = <span class="code-property">5</span>
}
            </div>

            <div class="hierarchy">
                <div class="license-tier hierarchy-item">
                    <div class="tier-header">Enterprise <span class="tier-value">(value=5)</span></div>
                    <div class="tier-description">Full feature set, includes Pro + Basic</div>
                </div>
                <div class="license-tier hierarchy-item pro">
                    <div class="tier-header">Professional <span class="tier-value">(value=4)</span></div>
                    <div class="tier-description">Enhanced features, includes Basic</div>
                </div>
                <div class="license-tier hierarchy-item basic">
                    <div class="tier-header">Basic <span class="tier-value">(value=1)</span></div>
                    <div class="tier-description">Base features only</div>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <h3 style="color: #81c784; margin-bottom: 10px;">License States <span class="code-ref">UserLicense.cs</span></h3>
                <div class="state-list">
                    <div class="state-item">
                        <div class="state-name">IsBasic <span class="code-ref">L189-242</span></div>
                        <div class="state-desc">Licenses.ContainsKey(Basic) && !IsProfessional && !IsEnterprise</div>
                    </div>
                    <div class="state-item">
                        <div class="state-name">IsProfessional <span class="code-ref">L326-367</span></div>
                        <div class="state-desc">Licenses.ContainsKey(Professional) || IsEnterprise</div>
                    </div>
                    <div class="state-item">
                        <div class="state-name">IsEnterprise <span class="code-ref">L438-470</span></div>
                        <div class="state-desc">Licenses.ContainsKey(Enterprise) && HasValue</div>
                    </div>
                    <div class="state-item">
                        <div class="state-name">IsActive <span class="code-ref">L126-184</span></div>
                        <div class="state-desc">Not expired</div>
                    </div>
                    <div class="state-item">
                        <div class="state-name">IsExpired <span class="code-ref">L567-627</span></div>
                        <div class="state-desc">Past expiration</div>
                    </div>
                    <div class="state-item">
                        <div class="state-name">IsTrial <span class="code-ref">L536-563</span></div>
                        <div class="state-desc">No license types</div>
                    </div>
                    <div class="state-item">
                        <div class="state-name">HasExpirationWarning <span class="code-ref">L631-679</span></div>
                        <div class="state-desc">&lt;30 days remaining</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 3: UserLicense 데이터 구조 -->
        <div class="section">
            <h2>Section 3: UserLicense 데이터 구조 <span class="code-ref">UserLicense.cs</span></h2>
            <div class="data-structure">
<span class="code-keyword">public class</span> <span class="code-type">UserLicense</span> {
    <span class="code-type">ulong</span> <span class="code-property">SerialNumber</span>;                          <span class="code-comment">// Dongle S/N</span>
    <span class="code-type">DateTime?</span> <span class="code-property">ExpirationDate</span>;                    <span class="code-comment">// License expiry</span>
    <span class="code-type">Dictionary&lt;LicenseType, DateTime?&gt;</span> <span class="code-property">Licenses</span>; <span class="code-comment">// Multi-tier</span>
}

<span class="code-keyword">public class</span> <span class="code-type">LicenseData</span> {
    <span class="code-type">string</span> <span class="code-property">GlobalId</span>;    <span class="code-comment">// Dongle unique ID</span>
    <span class="code-type">string</span> <span class="code-property">Signature</span>;   <span class="code-comment">// RSA signature</span>
}
            </div>
        </div>

        <!-- Section 4: DongleService 속성 -->
        <div class="section">
            <h2>Section 4: DongleService 속성 <span class="code-ref">DongleService.cs:32-228</span></h2>
            <div class="data-structure">
<span class="code-keyword">public</span> <span class="code-type">DongleType</span> <span class="code-property">Type</span>;
<span class="code-keyword">public</span> <span class="code-type">string</span> <span class="code-property">DongleID</span>;           <span class="code-comment">// Global unique ID</span>
<span class="code-keyword">public</span> <span class="code-type">ulong</span> <span class="code-property">SerialNumber</span>;        <span class="code-comment">// Dongle serial</span>
<span class="code-keyword">public</span> <span class="code-type">bool</span> <span class="code-property">IsPresent</span>;
<span class="code-keyword">public</span> <span class="code-type">bool</span> <span class="code-property">IsReadAuthorized</span>;
<span class="code-keyword">public</span> <span class="code-type">bool</span> <span class="code-property">IsWriteAuthorized</span>;
            </div>

            <div style="margin-top: 20px;">
                <h3 style="color: #81c784; margin-bottom: 10px;">Dongle Operations</h3>
                <div class="properties-list">
                    <div class="property-item">
                        <div class="property-name">IsPresent() <span class="code-ref">L145-209</span></div>
                        <div class="property-desc">Challenge-response validation</div>
                    </div>
                    <div class="property-item">
                        <div class="property-name">AuthorizeRead() <span class="code-ref">L290-299</span></div>
                        <div class="property-desc">Grant read permission</div>
                    </div>
                    <div class="property-item">
                        <div class="property-name">AuthorizeWrite() <span class="code-ref">L429-473</span></div>
                        <div class="property-desc">Grant write permission</div>
                    </div>
                    <div class="property-item">
                        <div class="property-name">ReadString() <span class="code-ref">L545-582</span></div>
                        <div class="property-desc">Read dongle memory</div>
                    </div>
                    <div class="property-item">
                        <div class="property-name">WriteString() <span class="code-ref">L584-604</span></div>
                        <div class="property-desc">Write dongle memory</div>
                    </div>
                    <div class="property-item">
                        <div class="property-name">LEDOn() / LEDOff() <span class="code-ref">L510-543</span></div>
                        <div class="property-desc">Control LED</div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <h3 style="color: #e91e63; margin-bottom: 10px;">Anti-tampering</h3>
                <div class="data-structure">
<span class="code-comment">// L14-18</span>
<span class="code-keyword">private static</span> <span class="code-type">ushort</span> <span class="code-property">ValidateCode1</span>, <span class="code-property">ValidateCode2</span>, <span class="code-property">ValidateCode3</span>;

<span class="code-comment">// L122-143: Bit rotation</span>
<span class="code-keyword">private static</span> <span class="code-type">ushort</span> <span class="code-property">RotateLeft</span>(<span class="code-type">ushort</span> val, <span class="code-type">int</span> n)
                </div>
            </div>
        </div>

        <!-- Section 5: 보안 계층 요약 -->
        <div class="section">
            <h2>Section 5: 보안 계층 요약</h2>
            <table class="security-table">
                <thead>
                    <tr>
                        <th>Layer</th>
                        <th>Technology</th>
                        <th>Source</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Hardware</td>
                        <td>KEYLOK USB dongle</td>
                        <td>KeylokDongle.cs</td>
                    </tr>
                    <tr>
                        <td>Firmware</td>
                        <td>Dongle internal memory</td>
                        <td>DongleService.cs</td>
                    </tr>
                    <tr>
                        <td>Network</td>
                        <td>Remote license server HTTPS</td>
                        <td>LicenseService.cs</td>
                    </tr>
                    <tr>
                        <td>Crypto</td>
                        <td>RSA signature verification</td>
                        <td>LicenseService.cs:274</td>
                    </tr>
                    <tr>
                        <td>Code</td>
                        <td>ConfuserEx obfuscation</td>
                        <td>All server files</td>
                    </tr>
                    <tr>
                        <td>Offline</td>
                        <td>OfflineSessionService grace period</td>
                        <td>OfflineSessionService.cs</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</body>
</html>
