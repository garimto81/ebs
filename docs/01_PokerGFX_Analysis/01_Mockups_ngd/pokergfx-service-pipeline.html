<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PokerGFX 서비스 아키텍처 + 카드 처리 파이프라인</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0a0e1a;
            color: #e0e0e0;
            padding: 20px;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            background: #151922;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        h1 {
            font-size: 28px;
            color: #ffffff;
            margin-bottom: 8px;
            text-align: center;
        }

        .subtitle {
            font-size: 14px;
            color: #888;
            text-align: center;
            margin-bottom: 30px;
            font-weight: normal;
        }

        h2 {
            font-size: 20px;
            color: #4fc3f7;
            margin: 30px 0 20px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #2a3441;
        }

        .section {
            margin-bottom: 40px;
        }

        /* Section 1: DI Hub-Spoke */
        .di-container {
            position: relative;
            height: 600px;
            margin: 30px 0;
        }

        .di-center {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 140px;
            height: 140px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
            z-index: 10;
        }

        .di-center-title {
            font-size: 24px;
            font-weight: bold;
            color: #fff;
        }

        .di-center-subtitle {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 4px;
        }

        .service-node {
            position: absolute;
            width: 180px;
            padding: 12px;
            background: #1e2531;
            border-radius: 8px;
            border: 2px solid;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .service-node-title {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .service-node-desc {
            font-size: 10px;
            color: #aaa;
            line-height: 1.3;
        }

        .service-line {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, rgba(79, 195, 247, 0.3), rgba(79, 195, 247, 0.8));
            transform-origin: left center;
        }

        /* Service colors */
        .service-blue { border-color: #42a5f5; }
        .service-blue .service-node-title { color: #42a5f5; }

        .service-green { border-color: #66bb6a; }
        .service-green .service-node-title { color: #66bb6a; }

        .service-orange { border-color: #ffa726; }
        .service-orange .service-node-title { color: #ffa726; }

        .service-purple { border-color: #ab47bc; }
        .service-purple .service-node-title { color: #ab47bc; }

        .service-red { border-color: #ef5350; }
        .service-red .service-node-title { color: #ef5350; }

        /* Code blocks */
        .code-block {
            background: #0d1117;
            border: 1px solid #2a3441;
            border-radius: 6px;
            padding: 16px;
            margin: 16px 0;
            overflow-x: auto;
        }

        .code-block pre {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.6;
            color: #c9d1d9;
        }

        .code-keyword { color: #ff7b72; }
        .code-type { color: #79c0ff; }
        .code-method { color: #d2a8ff; }
        .code-string { color: #a5d6ff; }
        .code-comment { color: #8b949e; font-style: italic; }
        .code-interface { color: #7ee787; }

        /* Pipeline flow */
        .pipeline {
            margin: 20px 0;
        }

        .pipeline-step {
            background: #1e2531;
            border-left: 4px solid #4fc3f7;
            padding: 12px 16px;
            margin: 12px 0;
            border-radius: 4px;
            position: relative;
        }

        .pipeline-step-title {
            font-size: 13px;
            font-weight: bold;
            color: #4fc3f7;
            margin-bottom: 4px;
        }

        .pipeline-step-desc {
            font-size: 11px;
            color: #bbb;
            line-height: 1.5;
        }

        .pipeline-step-file {
            font-size: 10px;
            color: #888;
            margin-top: 4px;
            font-family: 'Consolas', monospace;
        }

        .pipeline-arrow {
            text-align: center;
            color: #4fc3f7;
            font-size: 20px;
            margin: 8px 0;
        }

        /* Card format table */
        .card-format {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 16px 0;
        }

        .card-format-group {
            background: #1e2531;
            padding: 12px;
            border-radius: 6px;
        }

        .card-format-title {
            font-size: 12px;
            font-weight: bold;
            color: #4fc3f7;
            margin-bottom: 8px;
        }

        .card-format-list {
            font-size: 11px;
            color: #bbb;
            line-height: 1.8;
        }

        /* Performance box */
        .perf-box {
            background: #1a1f2e;
            border: 1px solid #2a3441;
            border-radius: 6px;
            padding: 16px;
            margin: 16px 0;
        }

        .perf-title {
            font-size: 13px;
            font-weight: bold;
            color: #66bb6a;
            margin-bottom: 10px;
        }

        .perf-list {
            font-size: 11px;
            color: #bbb;
            line-height: 1.8;
        }

        .perf-list li {
            margin-left: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>서비스 아키텍처 + 카드 처리 파이프라인</h1>
        <div class="subtitle">gfx.cs (8,121 LOC) Constructor DI - 10개 서비스 주입</div>

        <!-- Section 1: DI Architecture -->
        <div class="section">
            <h2>Section 1: gfx.cs 의존성 주입 (DI Hub-Spoke)</h2>

            <div class="code-block">
                <pre><span class="code-comment">// gfx.cs constructor - actual decompiled code</span>
<span class="code-keyword">public</span> <span class="code-method">gfx</span>(<span class="code-type">IServiceProvider</span> serviceProvider)
{
    _graphicElementsService    = <span class="code-method">GetRequiredService</span>&lt;<span class="code-type">IGraphicElementsService</span>&gt;();
    _gamePlayersService        = <span class="code-method">GetRequiredService</span>&lt;<span class="code-type">IGamePlayersService</span>&gt;();
    _gameCardsService          = <span class="code-method">GetRequiredService</span>&lt;<span class="code-type">IGameCardsService</span>&gt;();
    _gameVideoLiveService      = <span class="code-method">GetRequiredService</span>&lt;<span class="code-type">IGameVideoLiveService</span>&gt;();
    _effectsService            = <span class="code-method">GetRequiredService</span>&lt;<span class="code-type">IEffectsService</span>&gt;();
    _videoMixerService         = <span class="code-method">GetRequiredService</span>&lt;<span class="code-type">IVideoMixerService</span>&gt;();
    _transmisionEncodingService = <span class="code-method">GetRequiredService</span>&lt;<span class="code-type">ITransmisionEncodingService</span>&gt;();
    _handEvaluationService     = <span class="code-method">GetRequiredService</span>&lt;<span class="code-type">IHandEvaluationService</span>&gt;();
    _gameConfigurationService  = <span class="code-method">GetRequiredService</span>&lt;<span class="code-type">IGameConfigurationService</span>&gt;();
    _licenseService            = <span class="code-method">GetRequiredService</span>&lt;<span class="code-type">ILicenseService</span>&gt;();
}</pre>
            </div>

            <div class="di-container">
                <div class="di-center">
                    <div class="di-center-title">gfx</div>
                    <div class="di-center-subtitle">8,121 LOC</div>
                </div>

                <!-- Service Nodes positioned in circular pattern -->
                <div class="service-node service-blue" style="left: 50%; top: 5%; transform: translate(-50%, 0);">
                    <div class="service-node-title">IGraphicElementsService</div>
                    <div class="service-node-desc">요소 생명주기 관리<br>생성, 업데이트, 제거</div>
                </div>

                <div class="service-node service-blue" style="left: 85%; top: 15%; transform: translate(-50%, 0);">
                    <div class="service-node-title">IGamePlayersService</div>
                    <div class="service-node-desc">플레이어 데이터<br>이름, 스택, 위치</div>
                </div>

                <div class="service-node service-green" style="left: 95%; top: 40%; transform: translate(-50%, 0);">
                    <div class="service-node-title">IGameCardsService</div>
                    <div class="service-node-desc">카드 이미지 로딩/캐싱<br>GetNewCards() 핵심 메서드</div>
                </div>

                <div class="service-node service-orange" style="left: 85%; top: 70%; transform: translate(-50%, 0);">
                    <div class="service-node-title">IGameVideoLiveService</div>
                    <div class="service-node-desc">라이브 비디오 스트림<br>테이블 카메라 피드</div>
                </div>

                <div class="service-node service-purple" style="left: 50%; top: 85%; transform: translate(-50%, 0);">
                    <div class="service-node-title">IEffectsService</div>
                    <div class="service-node-desc">시각 효과<br>트랜지션, 애니메이션</div>
                </div>

                <div class="service-node service-orange" style="left: 15%; top: 70%; transform: translate(-50%, 0);">
                    <div class="service-node-title">IVideoMixerService</div>
                    <div class="service-node-desc">다중 소스 합성<br>카메라 + 그래픽 오버레이</div>
                </div>

                <div class="service-node service-orange" style="left: 5%; top: 40%; transform: translate(-50%, 0);">
                    <div class="service-node-title">ITransmisionEncodingService</div>
                    <div class="service-node-desc">출력 인코딩<br>NDI, RTMP, File</div>
                </div>

                <div class="service-node service-red" style="left: 15%; top: 15%; transform: translate(-50%, 0);">
                    <div class="service-node-title">IHandEvaluationService</div>
                    <div class="service-node-desc">핸드 평가 (외부 프록시)<br>HandEvalServiceProxy</div>
                </div>

                <div class="service-node service-blue" style="left: 30%; top: 2%; transform: translate(-50%, 0);">
                    <div class="service-node-title">IGameConfigurationService</div>
                    <div class="service-node-desc">게임 설정<br>룰, 타이밍, 레이아웃</div>
                </div>

                <div class="service-node service-red" style="left: 70%; top: 2%; transform: translate(-50%, 0);">
                    <div class="service-node-title">ILicenseService</div>
                    <div class="service-node-desc">라이선스 검증<br>프로덕션 활성화</div>
                </div>
            </div>
        </div>

        <!-- Section 2: ITagsService Interface -->
        <div class="section">
            <h2>Section 2: ITagsService 인터페이스</h2>
            <div class="code-block">
                <pre><span class="code-comment">// ITagsService.cs:6-26</span>
<span class="code-keyword">interface</span> <span class="code-interface">ITagsService</span>
{
    <span class="code-keyword">void</span> <span class="code-method">SetRFIDDelay</span>();
    <span class="code-keyword">void</span> <span class="code-method">SetRFIDFrequency</span>();
    <span class="code-keyword">void</span> <span class="code-method">SetRFIDFreq</span>();
    <span class="code-keyword">int</span> <span class="code-method">NumberOfCards</span>(<span class="code-keyword">byte</span> antenna);
    <span class="code-keyword">string</span> <span class="code-method">GetCard</span>(<span class="code-keyword">byte</span> antenna, <span class="code-keyword">byte</span> index);
    <span class="code-keyword">void</span> <span class="code-method">Purge</span>(<span class="code-keyword">int</span> antenna);
    <span class="code-keyword">bool</span> <span class="code-method">ForceClearAllTags</span>(<span class="code-type">TimeSpan</span> timeout);
    <span class="code-keyword">int</span> <span class="code-method">PlayerAntennasWithCards</span>(<span class="code-keyword">int</span> maxPlayers);
    <span class="code-keyword">void</span> <span class="code-method">AddDelegates</span>(<span class="code-type">GameType</span> gameType);
    <span class="code-keyword">void</span> <span class="code-method">RemoveDelegates</span>(<span class="code-type">GameType</span> gameType);
}</pre>
            </div>
        </div>

        <!-- Section 3: Card Processing Pipeline -->
        <div class="section">
            <h2>Section 3: 카드 처리 파이프라인 (Complete Data Flow)</h2>

            <div class="pipeline">
                <div class="pipeline-step">
                    <div class="pipeline-step-title">[RFID Reader Hardware]</div>
                    <div class="pipeline-step-desc">
                        RFID 안테나가 카드 UID 감지 (ISO 14443A/B)<br>
                        USB 또는 WiFi 통신으로 데이터 전송
                    </div>
                </div>

                <div class="pipeline-arrow">↓ tag_event_delegate</div>

                <div class="pipeline-step">
                    <div class="pipeline-step-title">Tags.OnTagEvent()</div>
                    <div class="pipeline-step-desc">
                        이벤트 핸들러 진입점<br>
                        <code>lock (tag_list)</code>로 동기화 보장
                    </div>
                    <div class="pipeline-step-file">Tags.cs:5412</div>
                </div>

                <div class="pipeline-arrow">↓ UID → Card String 변환</div>

                <div class="pipeline-step">
                    <div class="pipeline-step-title">saved_tag Lookup</div>
                    <div class="pipeline-step-desc">
                        <code>saved_tag.uid</code>를 <code>_packed_deck[card]</code>에서 조회<br>
                        UID → "As", "Kh" 등 카드 문자열 매핑
                    </div>
                    <div class="pipeline-step-file">Tags.cs:92-138</div>
                </div>

                <div class="pipeline-arrow">↓ Event Dispatch</div>

                <div class="pipeline-step">
                    <div class="pipeline-step-title">Event Delegates (3가지 타입)</div>
                    <div class="pipeline-step-desc">
                        • <code>Tags.CardEvent(antenna, on, card_str)</code> - 커뮤니티 카드<br>
                        • <code>Tags.PlayerEvent(antenna, on, card_str)</code> - 플레이어 카드<br>
                        • <code>Tags.UnknownEvent(antenna, on, card_str)</code> - 미매핑 UID<br>
                        구독 등록: <code>TagsService.AddDelegates(GameType)</code>
                    </div>
                    <div class="pipeline-step-file">Tags.cs:1779-1877</div>
                </div>

                <div class="pipeline-arrow">↓ GameType 처리</div>

                <div class="pipeline-step">
                    <div class="pipeline-step-title">GameType.ProcessCardDetectedByScanner()</div>
                    <div class="pipeline-step-desc">
                        게임 상태 업데이트 (board cards, player hands)<br>
                        카드 추가/제거에 따라 핸드 재평가 트리거
                    </div>
                </div>

                <div class="pipeline-arrow">↓ 카드 데이터 요청</div>

                <div class="pipeline-step">
                    <div class="pipeline-step-title">GameCardsService.GetNewCards()</div>
                    <div class="pipeline-step-desc">
                        카드 문자열 배열 반환 (예: ["As", "Kh", "7c"])<br>
                        캐싱된 카드 이미지 로드 준비
                    </div>
                    <div class="pipeline-step-file">GameCardsService.cs:240-337</div>
                </div>

                <div class="pipeline-arrow">↓ 렌더 데이터 준비</div>

                <div class="pipeline-step">
                    <div class="pipeline-step-title">render.init_hand(log._hand)</div>
                    <div class="pipeline-step-desc">
                        플레이어를 좌석에 매핑<br>
                        카드 가시성 설정 (face-up/face-down)<br>
                        애니메이션 시작 시간 계산
                    </div>
                    <div class="pipeline-step-file">render.cs</div>
                </div>

                <div class="pipeline-arrow">↓ 렌더 이벤트 발생</div>

                <div class="pipeline-step">
                    <div class="pipeline-step-title">gfx.render_event(game_event)</div>
                    <div class="pipeline-step-desc">
                        GraphicElement 데이터 업데이트<br>
                        트랜지션 애니메이션 트리거 (FadeIn, SlideIn)<br>
                        Dirty flag 설정으로 재렌더링 요청
                    </div>
                </div>

                <div class="pipeline-arrow">↓ 요소별 렌더링</div>

                <div class="pipeline-step">
                    <div class="pipeline-step-title">GraphicElement.RenderElement()</div>
                    <div class="pipeline-step-desc">
                        Transform 적용 (Position, Scale, Rotation, Opacity)<br>
                        카드 이미지를 Canvas에 Draw<br>
                        Z-order 정렬 (뒤에서 앞으로 그리기)
                    </div>
                </div>

                <div class="pipeline-arrow">↓ 최종 출력</div>

                <div class="pipeline-step" style="border-left-color: #66bb6a;">
                    <div class="pipeline-step-title" style="color: #66bb6a;">canvas.Render() → Video Output</div>
                    <div class="pipeline-step-desc">
                        NDI, RTMP, 또는 파일로 인코딩<br>
                        프레임 타임스탬프 기록, 다음 프레임 준비
                    </div>
                </div>
            </div>

            <div class="card-format">
                <div class="card-format-group">
                    <div class="card-format-title">카드 문자열 형식</div>
                    <div class="card-format-list">
                        <strong>{Rank}{Suit}</strong> 조합<br>
                        예시: As, Kh, 7c, Td
                    </div>
                </div>

                <div class="card-format-group">
                    <div class="card-format-title">Rank (13종)</div>
                    <div class="card-format-list">
                        A, K, Q, J, T, 9, 8, 7, 6, 5, 4, 3, 2
                    </div>
                </div>

                <div class="card-format-group">
                    <div class="card-format-title">Suit (4종)</div>
                    <div class="card-format-list">
                        s (spades, ♠)<br>
                        h (hearts, ♥)<br>
                        d (diamonds, ♦)<br>
                        c (clubs, ♣)
                    </div>
                </div>

                <div class="card-format-group">
                    <div class="card-format-title">특수 값</div>
                    <div class="card-format-list">
                        T = 10 (Ten)<br>
                        빈 문자열 = 카드 없음<br>
                        null = 초기화 전
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 4: Rendering Loop -->
        <div class="section">
            <h2>Section 4: 렌더링 루프 (Frame Update Cycle)</h2>

            <div class="code-block">
                <pre><span class="code-comment">// render.cs - 핸드 렌더링 스케줄러</span>
<span class="code-keyword">void</span> <span class="code-method">studio_render</span>()
{
    <span class="code-type">DateTime</span> t = <span class="code-method">GetCurrentTime</span>();

    <span class="code-comment">// 아직 렌더링되지 않은 핸드 찾기</span>
    <span class="code-keyword">foreach</span> (<span class="code-keyword">var</span> hand <span class="code-keyword">in</span> unrendered_hands)
    {
        <span class="code-keyword">if</span> (hand.start_time &lt;= t)
        {
            <span class="code-method">render_hand</span>(hand);
            hand.rendered = <span class="code-keyword">true</span>;
        }
    }
}

<span class="code-comment">// gfx.cs - 프레임 업데이트 루프</span>
<span class="code-keyword">void</span> <span class="code-method">FrameUpdate</span>()
{
    <span class="code-comment">// Z-order 정렬 (back to front)</span>
    <span class="code-keyword">var</span> sortedElements = elements.<span class="code-method">OrderBy</span>(e =&gt; e.ZPos);

    <span class="code-keyword">foreach</span> (<span class="code-keyword">var</span> element <span class="code-keyword">in</span> sortedElements)
    {
        <span class="code-keyword">if</span> (element.IsOnScreen)
        {
            element.<span class="code-method">UpdateAnimations</span>();  <span class="code-comment">// Position, Opacity 변화</span>
            element.<span class="code-method">Render</span>(canvas);       <span class="code-comment">// Canvas에 그리기</span>
        }
    }
}</pre>
            </div>

            <div class="perf-box">
                <div class="perf-title">성능 최적화 (코드에서 발견된 패턴)</div>
                <ul class="perf-list">
                    <li><strong>Dirty Flags:</strong> <code>redraw_name</code>, <code>redraw_stack</code>, <code>redraw_cards</code> 등으로 선택적 재렌더링</li>
                    <li><strong>Z-order Sorting:</strong> 프레임당 한 번만 정렬, 깊이 순서 보장</li>
                    <li><strong>SpeedFactor:</strong> 전역 애니메이션 속도 배율 (디버깅/슬로우모션)</li>
                    <li><strong>_boardFrameCountMs:</strong> 보드 카드 업데이트 쓰로틀링 (과도한 렌더링 방지)</li>
                    <li><strong>IsOnScreen 체크:</strong> 화면 밖 요소는 렌더링 스킵</li>
                    <li><strong>카드 이미지 캐싱:</strong> <code>GameCardsService</code>에서 사전 로드, 메모리 재사용</li>
                </ul>
            </div>

            <div class="code-block">
                <pre><span class="code-comment">// 애니메이션 업데이트 예시 (GraphicElement.cs)</span>
<span class="code-keyword">void</span> <span class="code-method">UpdateAnimations</span>()
{
    <span class="code-keyword">float</span> deltaTime = Time.DeltaTime * SpeedFactor;

    <span class="code-comment">// Position 트윈</span>
    <span class="code-keyword">if</span> (_positionTween.IsActive)
    {
        Position = <span class="code-type">Vector2</span>.<span class="code-method">Lerp</span>(
            _positionTween.Start,
            _positionTween.End,
            _positionTween.<span class="code-method">GetProgress</span>(deltaTime)
        );
    }

    <span class="code-comment">// Opacity 페이드</span>
    <span class="code-keyword">if</span> (_opacityTween.IsActive)
    {
        Opacity = <span class="code-type">Mathf</span>.<span class="code-method">Lerp</span>(
            _opacityTween.Start,
            _opacityTween.End,
            _opacityTween.<span class="code-method">GetProgress</span>(deltaTime)
        );
    }
}</pre>
            </div>
        </div>
    </div>
</body>
</html>
